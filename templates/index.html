<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeWhisperer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #121921; color: #F9FAFB; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #212934; }
        ::-webkit-scrollbar-thumb { background: #4A5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        
        /* --- NEW --- Header Animation */
        .mongodb-green {
            background-image: linear-gradient(90deg, #00ED64, #a7f3d0, #00ED64);
            background-size: 200% auto;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: animate-gradient 5s linear infinite;
        }

        @keyframes animate-gradient {
            to {
                background-position: -200% center;
            }
        }

        .mongodb-green-bg { background-color: #00684A; }
        .mongodb-green-bg-hover:hover { background-color: #00ED64; color: #121921; }
        .mongodb-dark-bg { background-color: #212934; }
        .mongodb-border { border-color: #4A5568; }
        .chat-bubble-user { background-color: #00684A; }
        .chat-bubble-ai { background-color: #212934; }
        .markdown-content pre { background-color: #0e131a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; overflow-x: auto; position: relative; }
        .markdown-content code { background-color: #121921; color: #F9FAFB; padding: 0.2rem 0.4rem; border-radius: 4px; }
        .markdown-content ul { list-style-type: disc; margin-left: 1.5rem; }
        details > summary { cursor: pointer; list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeInUp { animation: fadeInUp 0.3s ease-out forwards; }
        @keyframes pulse-shadow {
            0% { box-shadow: 0 0 0 0 rgba(0, 237, 100, 0.5); }
            70% { box-shadow: 0 0 0 12px rgba(0, 237, 100, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 237, 100, 0); }
        }
        .glow-on-ready {
            animation: pulse-shadow 1.5s 2;
        }
        @keyframes flash-success {
            0% { box-shadow: 0 0 0 0 rgba(192, 132, 252, 0); }
            50% { box-shadow: 0 0 8px 3px rgba(192, 132, 252, 0.7); }
            100% { box-shadow: 0 0 0 0 rgba(192, 132, 252, 0); }
        }
        .flash-on-add {
            animation: flash-success 1.5s ease-out;
        }
        .text-type-class { color: #C77DDd; } /* Purple */
        .text-type-function { color: #61AFEF; } /* Blue */
        .text-type-type { color: #56B6C2; } /* Teal */
        .text-type-module { color: #E5C07B; } /* Yellow */
        .context-meter-gradient { background: linear-gradient(to right, #22c55e, #facc15, #ef4444); }
        .chat-context-meter-gradient { background: linear-gradient(to right, #38bdf8, #a78bfa, #f472b6); }
        .context-indicator-bar { height: 4px; background-color: #4a5568; border-radius: 2px; transition: all 0.3s ease; opacity: 0; }
        .context-indicator-bar.visible { opacity: 1; }
        .context-indicator-bar.partial { background-image: repeating-linear-gradient(-45deg, #6b7280, #6b7280 5px, #4a5568 5px, #4a5568 10px); }
        .token-display { display: flex; align-items: center; gap: 0.5rem; font-family: monospace; font-size: 0.75rem; color: #9CA3AF; flex-shrink: 0; }
        .token-color-dot { width: 0.5rem; height: 0.5rem; border-radius: 9999px; }
        .file-label-wrapper { flex-grow: 1; min-width: 0; }
        .file-label { text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
        .bubble-actions { position: absolute; bottom: -12px; right: 10px; display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .chat-bubble-ai:hover .bubble-actions { opacity: 1; pointer-events: auto; }
        .bubble-action-btn { background-color: #4A5568; color: white; border: none; border-radius: 6px; height: 26px; padding: 0 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; font-weight: 500; }
        .bubble-action-btn:hover { background-color: #718096; }
        .summarize-btn { color: #a78bfa; transition: color 0.2s; }
        .summarize-btn:hover { color: #c4b5fd; }
        .summarize-btn:disabled { color: #6b7280; cursor: not-allowed; }
        .summary-container { border-left: 2px solid #a78bfa; background-color: rgba(167, 139, 250, 0.05); }
        .file-checkbox:disabled + * { opacity: 0.5; cursor: not-allowed; }
        .indexing-overlay {
            backdrop-filter: blur(4px);
            background-color: rgba(18, 25, 33, 0.8);
            transition: opacity 0.3s ease-in-out;
        }
        .recommended-file-link {
            cursor: pointer;
            color: #6ee7b7;
            text-decoration: underline;
            text-decoration-style: dotted;
        }
        .recommended-file-link:hover {
            color: #a7f3d0;
        }
        @keyframes breathe {
            0%, 100% { box-shadow: 0 0 5px rgba(0, 237, 100, 0.2), 0 0 10px rgba(0, 237, 100, 0.2); }
            50% { box-shadow: 0 0 15px rgba(0, 237, 100, 0.6), 0 0 25px rgba(0, 237, 100, 0.6); }
        }
        .progress-bar-glow {
            animation: breathe 2s ease-in-out infinite;
        }
        .modal-code-preview {
             background-color: #0e131a;
             border: 1px solid #4A5568;
             border-radius: 8px;
             padding: 1rem;
             font-family: monospace;
             font-size: 0.8rem;
             max-height: calc(90vh - 150px);
             overflow-y: auto;
             white-space: pre-wrap;
             word-break: break-all;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="flex items-center justify-between p-4 border-b mongodb-border shadow-lg">
        <div class="flex items-center space-x-3">
            <svg class="w-8 h-8" style="color: #00ED64;" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <style>
                @keyframes pulse {
                0%, 100% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.1);
                    opacity: 0.7;
                }
                }
                @keyframes rotate {
                from {
                    transform: rotate(0deg);
                }
                to {
                    transform: rotate(360deg);
                }
                }
                @keyframes scan-fade {
                0%, 100% {
                    opacity: 0;
                }
                25%, 75% {
                    opacity: 1;
                }
                }
                .pulse {
                animation: pulse 3s infinite;
                transform-origin: center;
                }
                .scanner {
                animation: rotate 5s linear infinite;
                transform-origin: center;
                }
                .scanner-dot {
                animation: scan-fade 2.5s infinite;
                }
                .scanner-dot-2 {
                animation: scan-fade 2.5s infinite;
                animation-delay: 1.25s;
                }
            </style>
            <path class="pulse" d="M16.889 12.042C16.889 15.783 13.824 18.848 10.083 18.848C6.342 18.848 3.277 15.783 3.277 12.042C3.277 8.301 6.342 5.236 10.083 5.236C10.113 5.236 10.142 5.237 10.172 5.237C10.232 5.237 10.29 5.236 10.35 5.236C10.35 6.428 10.813 7.525 11.583 8.301C12.354 9.076 13.451 9.539 14.643 9.539C14.643 9.599 14.644 9.657 14.644 9.717C14.644 9.747 14.645 9.776 14.645 9.806C15.93 9.926 16.889 10.885 16.889 12.162L16.889 12.042ZM14.643 7.46C13.818 7.46 13.088 7.047 12.639 6.388C12.981 6.331 13.334 6.302 13.702 6.302C15.991 6.302 17.86 8.171 17.86 10.46C17.86 10.828 17.831 11.181 17.774 11.523C17.115 11.074 16.602 10.344 16.602 9.539C16.602 8.371 15.749 7.46 14.643 7.46Z" />
            <g class="scanner">
                <circle class="scanner-dot" cx="12" cy="2" r="1" />
                <rect class="scanner-dot-2" x="20" y="11" width="2" height="2" rx="0.5"/>
            </g>
            </svg>
            <h1 class="text-2xl font-bold text-white" style="margin-left:0.25rem;">Code<span class="mongodb-green">Whisperer</span></h1>
        </div>
        <div class="flex items-center space-x-4">
            <div id="status-indicator" class="flex items-center space-x-2">
                <span id="status-text" class="text-sm text-gray-400 transition-all duration-300">Awaiting scan...</span>
                <div id="status-dot" class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
            </div>
            <button id="new-scan-btn" class="hidden px-3 py-2 text-sm font-semibold rounded-md mongodb-dark-bg border mongodb-border hover:bg-gray-700 transition-colors">
                <i class="fa-solid fa-plus mr-2"></i>New Scan
            </button>
             <div class="relative">
                <button id="convo-dropdown-btn" class="flex items-center space-x-2 p-2 rounded-md hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fa-solid fa-comments" style="color: #00ED64;"></i>
                    <span id="active-convo-name" class="text-sm">Main Thread</span>
                    <i class="fa-solid fa-chevron-down text-xs"></i>
                </button>
                <div id="convo-dropdown-menu" class="hidden absolute right-0 mt-2 w-72 bg-gray-900 rounded-md shadow-lg z-20 border mongodb-border">
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        <aside class="w-full md:w-2/5 lg:w-1/3 p-4 border-r mongodb-border overflow-y-auto flex flex-col space-y-4">
            <div id="scan-section">
                <h2 class="text-lg font-semibold mb-2">Analyze Codebase</h2>
                <div class="flex space-x-2">
                    <input type="text" id="path-input" placeholder="owner/repo, GitHub URL, or local path" class="flex-1 p-2 rounded-md bg-gray-800 border mongodb-border focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button id="scan-btn" class="px-4 py-2 font-semibold rounded-md mongodb-green-bg mongodb-green-bg-hover transition-all duration-200 active:scale-95">
                        <span id="scan-btn-text">Scan</span>
                        <svg id="scan-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
            </div>

            <div id="search-section" class="hidden">
                <h2 class="text-lg font-semibold mb-2">Search Code Snippets</h2>
                 <div class="flex space-x-2">
                    <div class="relative flex-1">
                         <input type="text" id="search-input" placeholder="Search indexed code..." class="w-full p-2 rounded-md bg-gray-800 border mongodb-border focus:outline-none focus:ring-2 focus:ring-green-500 transition-all duration-300 pr-8" disabled>
                         <button id="clear-search-btn" class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-white transition-colors p-1" title="Clear search">
                             <i class="fa-solid fa-xmark"></i>
                         </button>
                    </div>
                    <button id="search-btn" class="px-4 py-2 font-semibold rounded-md mongodb-green-bg mongodb-green-bg-hover transition-all duration-200 active:scale-95" disabled>
                        <span id="search-btn-text"><i class="fa-solid fa-search"></i></span>
                        <svg id="search-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
                <div id="search-results-container" class="mt-2 text-sm max-h-64 overflow-y-auto pr-2"></div>
                <div id="search-pagination-container" class="mt-2 flex justify-between items-center text-xs"></div>
            </div>

            <div id="context-builder-section" class="hidden flex-1 flex flex-col min-h-0 relative">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-semibold">Build Context</h2>
                    <span id="context-item-count" class="text-xs font-mono text-gray-400 bg-gray-900 px-2 py-1 rounded">0 items</span>
                </div>

                <div id="custom-context-section" class="mb-2"></div>

                <p class="text-sm text-gray-400 mb-3">Expand files, select items, or <i class="fa-solid fa-wand-magic-sparkles text-purple-400"></i> get AI summaries.</p>
                <div id="file-tree" class="flex-1 overflow-y-auto pr-2 space-y-1 mongodb-dark-bg p-2 rounded-lg border mongodb-border"></div>

                <div class="mt-3 pt-3 border-t border-gray-700 space-y-2">
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-400"><i class="fa-solid fa-code mr-1"></i>Code/Summary Context</span>
                        <div id="code-context-meter" class="flex items-center space-x-2 font-mono">
                            <span class="text-right w-24" id="context-token-count">~0 tokens</span>
                            <div class="w-20 h-2 rounded-full bg-gray-700 overflow-hidden"><div id="context-meter-fill" class="h-2 rounded-full context-meter-gradient transition-all duration-300" style="width: 100%; transform: translateX(-100%)"></div></div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                       <button id="manage-context-btn" class="text-gray-400 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled><i class="fa-solid fa-list-check mr-1"></i>Manage History Items</button>
                        <div id="chat-context-meter" class="flex items-center space-x-2 font-mono">
                            <span class="text-right w-24" id="chat-context-token-count">~0 tokens</span>
                            <div class="w-20 h-2 rounded-full bg-gray-700 overflow-hidden"><div id="chat-context-meter-fill" class="h-2 rounded-full chat-context-meter-gradient transition-all duration-300" style="width: 100%; transform: translateX(-100%)"></div></div>
                        </div>
                    </div>
                </div>

                <div id="indexing-progress-section" class="indexing-overlay absolute inset-0 z-10 flex-col items-center justify-center p-6 rounded-lg hidden">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-200">Preparing Your Codebase...</h3>
                        <p id="indexing-stage-text" class="text-sm text-green-400 mt-1 font-mono">Phase 1/3: Generating summaries...</p>
                    </div>
                    <div class="w-full max-w-md mt-4">
                        <span id="indexing-progress-text" class="font-mono text-sm text-gray-300"></span>
                        <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2 shadow-inner">
                            <div id="indexing-progress-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-500 progress-bar-glow" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="indexing-pro-tip" class="mt-6 text-center text-xs text-gray-400 italic p-2 border-t border-gray-700 w-full max-w-md"></div>
                </div>
            </div>
        </aside>

        <section class="flex-1 flex flex-col p-4">
            <div id="chat-window" class="flex-1 overflow-y-auto mb-4 pr-2">
                 <div class="chat-bubble-ai p-4 rounded-lg max-w-4xl markdown-content">
                     <p>Welcome to CodeWhisperer! Start by scanning a codebase. You can then branch conversations from any AI response to explore different paths of inquiry.</p>
                 </div>
            </div>
            <div id="preset-buttons" class="mb-2 flex-wrap gap-2 hidden">
                <button type="button" class="preset-btn text-sm p-2 rounded-md mongodb-dark-bg hover:bg-gray-700 transition-colors" data-question="Provide a high-level summary of this project based on the selected context.">High-level summary</button>
                <button type="button" class="preset-btn text-sm p-2 rounded-md mongodb-dark-bg hover:bg-gray-700 transition-colors" data-question="From the selected code, identify the main dependencies and libraries used.">Identify dependencies</button>
                <button type="button" class="preset-btn text-sm p-2 rounded-md mongodb-dark-bg hover:bg-gray-700 transition-colors" data-question="Based on the selected files, explain the core logic and primary purpose of this application.">Explain the core logic</button>
            </div>
            <div class="mt-auto">
                <form id="chat-form" class="flex items-center space-x-2">
                    <input type="text" id="message-input" placeholder="Select code snippets to begin..." class="flex-1 p-3 rounded-md bg-gray-800 border mongodb-border focus:outline-none focus:ring-2 focus:ring-green-500 transition-all duration-300" disabled>
                    <button type="button" id="preview-context-btn" class="p-3 rounded-md mongodb-dark-bg border mongodb-border hover:bg-gray-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled title="Preview Context">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                    <button type="submit" id="send-btn" class="p-3 rounded-md mongodb-green-bg mongodb-green-bg-hover transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa-solid fa-paper-plane w-5 h-5"></i>
                    </button>
                </form>
            </div>
        </section>
    </main>

    <div id="chat-context-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-900 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b mongodb-border">
                <h2 class="text-lg font-semibold">Manage Chat History Items</h2>
                <div class="flex items-center space-x-4">
                    <button id="modal-select-all" class="text-sm text-gray-400 hover:text-white">Select All</button>
                    <button id="modal-deselect-all" class="text-sm text-gray-400 hover:text-white">Deselect All</button>
                    <button id="close-chat-context-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
            </div>
            <div id="modal-chat-history" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
        </div>
    </div>

    <div id="review-context-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-900 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b mongodb-border">
                <h2 id="review-modal-title" class="text-lg font-semibold">Review Snippet</h2>
                <button id="close-review-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <p class="text-sm text-gray-400 mb-2">Review the code below. You can make edits or add comments before including it in the chat context.</p>
                <div id="review-modal-warning" class="hidden bg-yellow-900/50 border border-yellow-700 text-yellow-300 text-xs rounded-md p-3 mb-4 flex items-start">
                    <i class="fa-solid fa-triangle-exclamation w-4 h-4 mr-3 mt-0.5"></i>
                    <div>
                        <h4 class="font-semibold">Surgical Context</h4>
                        <p class="mt-1">Adding this specific snippet will prevent selecting the entire file for context. This allows for more precise questions. You can remove the snippet later to re-enable whole-file selection.</p>
                    </div>
                </div>
                <textarea id="review-modal-code" class="w-full h-96 bg-gray-950 border mongodb-border rounded-md p-2 font-mono text-sm"></textarea>
            </div>
            <div class="p-4 border-t mongodb-border flex justify-end space-x-2">
                 <button id="cancel-review-modal-btn" class="px-4 py-2 text-sm font-semibold rounded-md mongodb-dark-bg border mongodb-border hover:bg-gray-700 transition-colors">Cancel</button>
                 <button id="add-reviewed-snippet-btn" class="px-4 py-2 font-semibold rounded-md mongodb-green-bg mongodb-green-bg-hover transition-all duration-200 active:scale-95">Add Snippet to Context</button>
            </div>
        </div>
    </div>

    <div id="preview-context-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-900 rounded-lg shadow-xl w-full max-w-7xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b mongodb-border">
                <h2 class="text-lg font-semibold"><i class="fa-solid fa-file-import mr-2"></i>Final Prompt Preview</h2>
                <button id="close-preview-context-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold text-green-400 mb-2 border-b border-gray-700 pb-2 flex items-center"><i class="fa-solid fa-code mr-2"></i>Codebase Context</h3>
                    <div id="preview-code-context" class="modal-code-preview text-gray-300"></div>
                </div>
                <div>
                    <h3 class="font-semibold text-blue-400 mb-2 border-b border-gray-700 pb-2 flex items-center"><i class="fa-solid fa-comments mr-2"></i>Conversation History</h3>
                    <div id="preview-history-context" class="modal-code-preview text-gray-300"></div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- UI Elements ---
    const ui = {
        scanSection: document.getElementById('scan-section'),
        newScanBtn: document.getElementById('new-scan-btn'),
        scanBtn: document.getElementById('scan-btn'), pathInput: document.getElementById('path-input'),
        messageInput: document.getElementById('message-input'), sendBtn: document.getElementById('send-btn'),
        chatForm: document.getElementById('chat-form'), chatWindow: document.getElementById('chat-window'),
        statusText: document.getElementById('status-text'), statusDot: document.getElementById('status-dot'),
        scanBtnText: document.getElementById('scan-btn-text'), scanSpinner: document.getElementById('scan-spinner'),
        contextBuilderSection: document.getElementById('context-builder-section'), fileTree: document.getElementById('file-tree'),
        presetButtons: document.getElementById('preset-buttons'), contextItemCount: document.getElementById('context-item-count'),
        contextTokenCount: document.getElementById('context-token-count'), contextMeterFill: document.getElementById('context-meter-fill'),
        chatContextTokenCount: document.getElementById('chat-context-token-count'), chatContextMeterFill: document.getElementById('chat-context-meter-fill'),
        manageContextBtn: document.getElementById('manage-context-btn'), chatContextModal: document.getElementById('chat-context-modal'),
        closeChatContextModalBtn: document.getElementById('close-chat-context-modal-btn'), modalChatHistory: document.getElementById('modal-chat-history'),
        modalSelectAll: document.getElementById('modal-select-all'), modalDeselectAll: document.getElementById('modal-deselect-all'),
        convoDropdownBtn: document.getElementById('convo-dropdown-btn'), convoDropdownMenu: document.getElementById('convo-dropdown-menu'),
        activeConvoName: document.getElementById('active-convo-name'),
        searchSection: document.getElementById('search-section'), searchInput: document.getElementById('search-input'),
        searchBtn: document.getElementById('search-btn'), searchBtnText: document.getElementById('search-btn-text'),
        searchSpinner: document.getElementById('search-spinner'), searchResultsContainer: document.getElementById('search-results-container'),
        searchPaginationContainer: document.getElementById('search-pagination-container'),
        clearSearchBtn: document.getElementById('clear-search-btn'), // NEW
        indexingProgressSection: document.getElementById('indexing-progress-section'),
        indexingProgressText: document.getElementById('indexing-progress-text'),
        indexingProgressBar: document.getElementById('indexing-progress-bar'),
        indexingStageText: document.getElementById('indexing-stage-text'),
        indexingProTip: document.getElementById('indexing-pro-tip'),
        reviewContextModal: document.getElementById('review-context-modal'),
        reviewModalTitle: document.getElementById('review-modal-title'),
        reviewModalCode: document.getElementById('review-modal-code'),
        reviewModalWarning: document.getElementById('review-modal-warning'),
        addReviewedSnippetBtn: document.getElementById('add-reviewed-snippet-btn'),
        closeReviewModalBtn: document.getElementById('close-review-modal-btn'),
        cancelReviewModalBtn: document.getElementById('cancel-review-modal-btn'),
        customContextSection: document.getElementById('custom-context-section'),
        previewContextBtn: document.getElementById('preview-context-btn'),
        previewContextModal: document.getElementById('preview-context-modal'),
        closePreviewContextModalBtn: document.getElementById('close-preview-context-modal-btn'),
        previewCodeContext: document.getElementById('preview-code-context'),
        previewHistoryContext: document.getElementById('preview-history-context'),
    };

    // --- Constants ---
    const CONTEXT_TOKEN_LIMIT = 200000;
    const CHAR_COUNT_MEDIUM = 8000;
    const CHAR_COUNT_LARGE = 32000;
    const RESULTS_PER_PAGE = 3;
    const PRO_TIPS = [
        "Pro-Tip: Use the search to find where a specific function is called.",
        "Did you know? Code Whisperer uses both keyword and vector search for the best results.",
        "Pro-Tip: You can edit code snippets from search results before adding them to context.",
        "Did you know? Selecting a whole file can provide broad context, while snippets offer precision.",
        "Pro-Tip: Branch conversations to explore different questions without losing your original chat history.",
        "Did you know? The context token meter helps you manage the size of the prompt sent to the AI.",
    ];

    // --- State Management ---
    let scannedFilesData = {}; // Now stores full content
    let messageStore = new Map();
    let conversations = {};
    let activeConversationId = null;
    let contextMessageIds = new Set();
    let indexingStatusInterval = null;
    let proTipInterval = null;
    let currentSessionId = null;
    let searchResultsStore = {};
    let customContextSnippets = [];
    let fullSearchResults = [];
    let searchResultsCurrentPage = 1;

    function initNewConversation(id, name, messages = []) {
        conversations[id] = { id, name, messages };
    }

    function resetForNewScan() {
        scannedFilesData = {};
        messageStore.clear();
        conversations = {};
        activeConversationId = 'main_thread';
        initNewConversation(activeConversationId, 'Main Thread');
        contextMessageIds.clear();
        if (indexingStatusInterval) clearInterval(indexingStatusInterval);
        if (proTipInterval) clearInterval(proTipInterval);
        currentSessionId = null;
        searchResultsStore = {};
        customContextSnippets = [];
        fullSearchResults = [];
        searchResultsCurrentPage = 1;

        ui.contextBuilderSection.classList.add('hidden');
        ui.searchSection.classList.add('hidden');
        ui.indexingProgressSection.classList.add('hidden');
        ui.fileTree.innerHTML = '';
        clearSearch(); // NEW: Clear search on new scan
        ui.presetButtons.classList.add('hidden');
        ui.messageInput.disabled = true;
        ui.sendBtn.disabled = true;
        ui.previewContextBtn.disabled = true;
        ui.manageContextBtn.disabled = true;
        ui.convoDropdownBtn.disabled = true;
        ui.messageInput.placeholder = "Select code snippets to begin...";
        ui.statusDot.classList.remove('bg-green-500', 'bg-red-500');
        ui.statusDot.classList.add('bg-yellow-500', 'animate-pulse');
        ui.statusText.textContent = 'Awaiting scan...';

        ui.scanSection.style.display = 'block';
        ui.newScanBtn.style.display = 'none';

        renderActiveConversation();
        updateAllVisuals();
    }

    // --- Core Functions ---

    function createMessage(role, content) {
        const messageId = `msg-${Date.now()}-${Math.random()}`;
        const message = { role, content };
        messageStore.set(messageId, message);
        conversations[activeConversationId].messages.push(messageId);
        contextMessageIds.add(messageId);
        return messageId;
    }

    function renderMessage(messageId) {
        const message = messageStore.get(messageId);
        if (!message) return;

        const { role, content } = message;
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `flex mb-4 animate-fadeInUp ${role === 'user' ? 'justify-end' : 'justify-start'}`;

        const bubble = document.createElement('div');
        bubble.className = `p-4 rounded-lg max-w-4xl relative ${role === 'user' ? 'chat-bubble-user text-white' : 'chat-bubble-ai'}`;
        bubble.innerHTML = `<div class="markdown-content">${marked.parse(content)}</div>`;

        if (role === 'assistant') {
            const actions = document.createElement('div');
            actions.className = 'bubble-actions';
            actions.innerHTML = `<button type="button" class="bubble-action-btn branch-btn" data-message-id="${messageId}">Branch <i class="fa-solid fa-code-branch fa-xs ml-1"></i></button>`;
            bubble.appendChild(actions);
        }

        messageWrapper.appendChild(bubble);
        ui.chatWindow.appendChild(messageWrapper);
        enhanceCodeBlocks(bubble);
    }

    function renderActiveConversation() {
        if (!activeConversationId) return;
        ui.chatWindow.innerHTML = '';
        const activeConvo = conversations[activeConversationId];
        activeConvo.messages.forEach(msgId => renderMessage(msgId));
        ui.chatWindow.scrollTop = ui.chatWindow.scrollHeight;
        updateConversationDropdown();
        updateChatContextMeter();
    }

    function setScanningState(isScanning) {
        ui.scanBtn.disabled = isScanning;
        ui.pathInput.disabled = isScanning;
        ui.scanSpinner.classList.toggle('hidden', !isScanning);
        ui.scanBtnText.classList.toggle('hidden', isScanning);
    }

    function enhanceCodeBlocks(container) {
        container.querySelectorAll('pre').forEach(pre => {
            if (pre.querySelector('.copy-btn')) return;
            const code = pre.querySelector('code');
            const copyBtn = document.createElement('button');
            copyBtn.type = 'button';
            copyBtn.innerHTML = '<i class="far fa-copy"></i>';
            copyBtn.title = 'Copy code';
            copyBtn.className = 'bubble-action-btn copy-btn absolute top-2 right-2 w-7 h-7 rounded-full';
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(code.innerText).then(() => {
                    copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => { copyBtn.innerHTML = '<i class="far fa-copy"></i>'; }, 2000);
                });
            };
            pre.appendChild(copyBtn);
        });
    }

    // --- UI Update & Visuals ---
    function updateAllVisuals() {
        renderCustomContextSnippets();
        updateFileTreeInteractivity();
        updateContextItemCount();
        updateContextMeter();
        updateChatContextMeter();
        updateFileVisuals();
    }

    function renderCustomContextSnippets() {
        ui.customContextSection.innerHTML = ''; // Clear previous entries
        if (customContextSnippets.length === 0) return;

        const snippetsHTML = customContextSnippets.map(snippet => `
            <div class="mongodb-dark-bg p-2 my-1 rounded-md border border-purple-600 flex justify-between items-center" data-snippet-id="${snippet.id}">
                <div class="flex-1 min-w-0">
                    <div class="text-xs font-semibold text-purple-400 truncate"><i class="fa-solid fa-pen-to-square mr-2"></i>${snippet.source}</div>
                </div>
                <div class="flex-shrink-0">
                    <button class="edit-custom-snippet-btn text-gray-400 hover:text-white ml-2" data-id="${snippet.id}" title="Edit Snippet">
                        <i class="fa-solid fa-pencil"></i>
                    </button>
                    <button class="remove-custom-snippet-btn text-gray-400 hover:text-red-500 ml-2" data-id="${snippet.id}" title="Remove Snippet">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            </div>
        `).join('');

        ui.customContextSection.innerHTML = `
            <h3 class="text-sm font-semibold text-gray-300 mt-2 mb-1">Custom Snippets</h3>
            ${snippetsHTML}
        `;
    }

    function updateContextItemCount() {
        const fileTreeCount = ui.fileTree.querySelectorAll('input[type="checkbox"]:checked').length;
        const customCount = customContextSnippets.length;
        const totalCount = fileTreeCount + customCount;
        ui.contextItemCount.textContent = `${totalCount} items`;
    }

    function updateContextMeter() {
        let charCount = 0;
        const selectedCode = getSelectedCodeItems();
        for (const path in selectedCode) {
            if (selectedCode[path].includes('__all__')) {
                charCount += scannedFilesData[path]?.char_count || 0;
            } else {
                charCount += selectedCode[path].length * 1000; // Rough estimate for snippets
            }
        }
        const selectedSummaries = getSelectedSummaryItems();
        for (const summary of selectedSummaries) {
            charCount += summary.content.length;
        }
        for (const snippet of customContextSnippets) {
            charCount += snippet.content.length;
        }
        const tokenEstimate = Math.floor(charCount / 4);
        ui.contextTokenCount.textContent = `~${tokenEstimate.toLocaleString()} tokens`;
        const percentage = Math.min(100, (tokenEstimate / CONTEXT_TOKEN_LIMIT) * 100);
        ui.contextMeterFill.style.transform = `translateX(-${100 - percentage}%)`;
    }

    function updateChatContextMeter() {
        let charCount = 0;
        for (const messageId of contextMessageIds) {
            const state = messageStore.get(messageId);
            if (state) {
                charCount += (typeof state.content === 'string' ? state.content.length : 0);
            }
        }
        const tokenEstimate = Math.floor(charCount / 4);
        ui.chatContextTokenCount.textContent = `~${tokenEstimate.toLocaleString()} tokens`;
        const percentage = Math.min(100, (tokenEstimate / CONTEXT_TOKEN_LIMIT) * 100);
        ui.chatContextMeterFill.style.transform = `translateX(-${100 - percentage}%)`;
    }

    function updateFileVisuals() {
        ui.fileTree.querySelectorAll('details').forEach(detail => {
            const indicator = detail.querySelector('.context-indicator-bar');
            if (!indicator) return;
            const fileCheckbox = detail.querySelector('input[data-type="file-code"]');
            if (!fileCheckbox) return;

            indicator.classList.remove('visible', 'partial', 'bg-blue-500', 'bg-yellow-500', 'bg-red-500');
            if (fileCheckbox.checked || fileCheckbox.indeterminate) {
                const charCount = parseInt(detail.dataset.charCount, 10);
                indicator.classList.add('visible');
                if (fileCheckbox.indeterminate) indicator.classList.add('partial');
                if (charCount > CHAR_COUNT_LARGE) indicator.classList.add('bg-red-500');
                else if (charCount > CHAR_COUNT_MEDIUM) indicator.classList.add('bg-yellow-500');
                else indicator.classList.add('bg-blue-500');
            }
        });
    }

    function updateChatUI() {
        const selectedFileTreeCount = ui.fileTree.querySelectorAll('input[type="checkbox"]:checked').length;
        const hasCustomSnippets = customContextSnippets.length > 0;
        const hasContext = selectedFileTreeCount > 0 || hasCustomSnippets;
        const hasMessages = conversations[activeConversationId]?.messages.length > 0;

        ui.manageContextBtn.disabled = !hasMessages;
        ui.convoDropdownBtn.disabled = Object.keys(conversations).length === 0;

        if (hasContext) {
            ui.messageInput.disabled = false;
            ui.sendBtn.disabled = false;
            ui.previewContextBtn.disabled = false;
            ui.messageInput.placeholder = `Ask about the selected context...`;
            if (ui.presetButtons.classList.contains('hidden')) {
                 ui.presetButtons.classList.remove('hidden');
                 ui.presetButtons.classList.add('flex', 'animate-fadeInUp');
            }
        } else {
            ui.messageInput.disabled = true;
            ui.sendBtn.disabled = true;
            ui.previewContextBtn.disabled = true;
            ui.messageInput.placeholder = "Select code snippets or summaries to begin...";
            ui.presetButtons.classList.add('hidden');
            ui.presetButtons.classList.remove('flex', 'animate-fadeInUp');
        }
        updateAllVisuals();
    }

    // --- Event Handlers & API Calls ---
    ui.scanBtn.addEventListener('click', async () => {
        const path = ui.pathInput.value.trim() || '.';
        setScanningState(true);
        resetForNewScan();
        ui.statusText.textContent = 'Scanning and analyzing...';
        try {
            const response = await fetch('/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path }),
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Unknown error');

            currentSessionId = result.sessionId;
            ui.statusText.textContent = `Scanned: ${result.displayName}`;
            ui.statusDot.classList.remove('bg-yellow-500', 'animate-pulse');
            ui.statusDot.classList.add('bg-green-500');

            scannedFilesData = result.files.reduce((acc, file) => {
                acc[file.path] = { char_count: file.char_count, content: file.content };
                return acc;
            }, {});

            result.files.forEach(file => createFileTreeItem(file, false));

            ui.scanSection.style.display = 'none';
            ui.newScanBtn.style.display = 'block';

            ui.searchSection.classList.remove('hidden');
            ui.searchSection.classList.add('animate-fadeInUp');
            ui.contextBuilderSection.classList.remove('hidden');
            ui.contextBuilderSection.classList.add('animate-fadeInUp');

            startIndexingStatusPoller();

            const messageContent = `Analysis complete for \`${result.displayName}\`. The file tree is now available on the left. **Please select files or snippets to build your context** and start asking questions.
            <br><br>I am now indexing all functions and classes in the background. This will enable search and other advanced features shortly.`;

            createMessage('assistant', messageContent);
            renderActiveConversation();
            updateChatUI();
        } catch (error) {
            ui.statusText.textContent = 'Scan failed.';
            ui.statusDot.classList.add('bg-red-500');
            createMessage('assistant', `**Error:** ${error.message}`);
            renderActiveConversation();
        } finally {
            setScanningState(false);
        }
    });

    function createFileTreeItem(file, isRecommended = false) {
        const details = document.createElement('details');
        details.className = 'bg-gray-800/50 rounded-md';
        details.dataset.path = file.path;
        details.dataset.charCount = file.char_count;
        details.dataset.loaded = 'false';

        const summary = document.createElement('summary');
        summary.className = 'flex items-center justify-between p-2 cursor-pointer hover:bg-gray-700/50 rounded-md';

        const leftSide = document.createElement('div');
        leftSide.className = 'flex items-center min-w-0';

        const fileCheckbox = document.createElement('input');
        fileCheckbox.type = 'checkbox';
        fileCheckbox.className = 'h-4 w-4 rounded text-green-500 bg-gray-700 border-gray-600 focus:ring-green-600 flex-shrink-0 file-checkbox';
        fileCheckbox.dataset.type = 'file-code';
        fileCheckbox.checked = isRecommended;

        const icon = document.createElement('i');
        icon.className = `fa-solid fa-chevron-right w-6 text-center transition-transform flex-shrink-0`;
        details.addEventListener('toggle', () => icon.classList.toggle('fa-rotate-90'));

        const ICONS = { file: 'fa-regular fa-file-code', class: 'fa-solid fa-cube text-type-class', function: 'fa-solid fa-microchip text-type-function', type: 'fa-solid fa-tag text-type-type', module: 'fa-solid fa-cubes text-type-module' };
        const fileIcon = document.createElement('i');
        fileIcon.className = `${ICONS.file} mx-2 text-gray-400 flex-shrink-0`;

        const labelWrapper = document.createElement('div');
        labelWrapper.className = 'file-label-wrapper';
        const label = document.createElement('span');
        label.textContent = file.path;
        label.className = 'text-sm file-label';
        labelWrapper.appendChild(label);

        const lockIndicator = document.createElement('span');
        lockIndicator.className = 'lock-indicator hidden ml-2 text-yellow-400';
        lockIndicator.innerHTML = '<i class="fa-solid fa-lock"></i>';

        const summarizeFileBtn = document.createElement('button');
        summarizeFileBtn.type = 'button';
        summarizeFileBtn.className = 'summarize-btn ml-2 flex-shrink-0';
        summarizeFileBtn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i>`;
        summarizeFileBtn.title = 'Get AI summary for this file';
        summarizeFileBtn.dataset.path = file.path;

        leftSide.append(fileCheckbox, icon, fileIcon, labelWrapper, lockIndicator, summarizeFileBtn);

        const tokenDisplay = document.createElement('span');
        tokenDisplay.className = 'token-display ml-2';
        const tokenDot = document.createElement('span');
        tokenDot.className = 'token-color-dot';
        const charCount = file.char_count;
        if (charCount > CHAR_COUNT_LARGE) tokenDot.classList.add('bg-red-500');
        else if (charCount > CHAR_COUNT_MEDIUM) tokenDot.classList.add('bg-yellow-500');
        else tokenDot.classList.add('bg-blue-500');

        const tokenText = document.createElement('span');
        tokenText.textContent = `~${Math.floor(charCount / 4).toLocaleString()}tk`;
        tokenDisplay.append(tokenDot, tokenText);

        const indicator = document.createElement('div');
        indicator.className = 'context-indicator-bar w-full mt-2';

        summary.append(leftSide, tokenDisplay);
        const summaryContainer = document.createElement('div');
        summaryContainer.className = 'summary-target-file';
        details.append(summary, summaryContainer, indicator);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'pl-8 pr-2 pb-2';
        details.appendChild(contentDiv);
        ui.fileTree.appendChild(details);

        details.addEventListener('toggle', async (e) => {
            if (details.open && details.dataset.loaded === 'false') {
                contentDiv.innerHTML = `<div class="text-xs text-gray-500">Loading structure...</div>`;
                try {
                    const response = await fetch('/structure', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({path: file.path})
                    });
                    const structure = await response.json();
                    if (!response.ok) throw new Error(structure.error);
                    details.dataset.loaded = 'true';
                    contentDiv.innerHTML = '';
                    if (structure.length > 0) {
                        structure.forEach(item => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'flex items-center mt-1';

                            const itemCheckbox = document.createElement('input');
                            itemCheckbox.type = 'checkbox';
                            itemCheckbox.className = 'h-4 w-4 rounded text-green-500 bg-gray-700 border-gray-600 focus:ring-green-600';
                            itemCheckbox.value = item.name;
                            itemCheckbox.dataset.type = 'item-code';
                            itemCheckbox.checked = fileCheckbox.checked;

                            const summarizeItemBtn = document.createElement('button');
                            summarizeItemBtn.type = 'button';
                            summarizeItemBtn.className = 'summarize-btn mx-2 snippet-summarize-btn';
                            summarizeItemBtn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i>`;
                            summarizeItemBtn.title = `Get AI summary for ${item.type} ${item.name}`;
                            summarizeItemBtn.dataset.path = file.path;
                            summarizeItemBtn.dataset.name = item.name;

                            const itemIcon = document.createElement('i');
                            itemIcon.className = `${ICONS[item.type] || 'fa-solid fa-code'} w-6 text-center`;

                            const itemLabel = document.createElement('span');
                            itemLabel.textContent = item.name;
                            itemLabel.className = `text-sm text-type-${item.type}`;

                            const summaryTarget = document.createElement('div');
                            summaryTarget.className = `summary-target-item ml-12`;

                            itemDiv.append(itemCheckbox, summarizeItemBtn, itemIcon, itemLabel);
                            contentDiv.append(itemDiv, summaryTarget);
                        });
                    } else {
                        contentDiv.innerHTML = `<div class="text-xs text-gray-500 italic">No functions or classes found.</div>`;
                    }
                } catch(error) {
                    contentDiv.innerHTML = `<div class="text-xs text-red-400">Error: ${error.message}</div>`;
                }
            }
        });
    }

    function getSelectedCodeItems() {
        const selected = {};
        ui.fileTree.querySelectorAll('details').forEach(detail => {
            const filePath = detail.dataset.path;
            const fileCheckbox = detail.querySelector('input[data-type="file-code"]');
            const itemCheckboxes = detail.querySelectorAll('input[data-type="item-code"]:checked');

            if (fileCheckbox && fileCheckbox.checked) {
                selected[filePath] = ['__all__'];
            } else if (itemCheckboxes.length > 0) {
                selected[filePath] = Array.from(itemCheckboxes).map(cb => cb.value);
            }
        });
        return selected;
    }

    function getSelectedSummaryItems() {
        const summaries = [];
        ui.fileTree.querySelectorAll('input[data-type="summary"]:checked').forEach(cb => {
            summaries.push({
                path: cb.dataset.path,
                name: cb.dataset.name || null,
                content: cb.dataset.content,
            });
        });
        return summaries;
    }

    async function handleFetchSummary(path, name = null) {
        const btnSelector = name ? `button[data-path="${path}"][data-name="${name}"]` : `button[data-path="${path}"]:not([data-name])`;
        const btn = document.querySelector(btnSelector);
        if(!btn) return;

        let summaryContainer;
        if (name) {
            summaryContainer = btn.closest('.flex.items-center').nextElementSibling;
        } else {
            summaryContainer = btn.closest('details').querySelector('.summary-target-file');
        }

        if(!summaryContainer) return;

        btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
        btn.disabled = true;

        try {
            const response = await fetch('/summarize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path, name, sessionId: currentSessionId })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Failed to generate summary');

            summaryContainer.innerHTML = `
                <div class="summary-container p-2 mt-2 ml-4 rounded-md animate-fadeInUp">
                    <div class="flex items-start">
                         <input type="checkbox" data-type="summary" data-path="${path}" ${name ? `data-name="${name}"` : ''} data-content="${result.answer.replace(/"/g, '&quot;')}" class="h-4 w-4 rounded text-purple-400 bg-gray-700 border-gray-600 focus:ring-purple-500 mt-1 flex-shrink-0" onchange="updateChatUI()">
                         <div class="ml-2 text-xs text-gray-300">${marked.parse(result.answer)}</div>
                    </div>
                </div>`;
        } catch (error) {
            summaryContainer.innerHTML = `<div class="text-xs text-red-400 p-2">${error.message}</div>`;
        } finally {
            btn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i>`;
            if (!name) {
                btn.disabled = false;
            }
        }
    }

    async function handleSendMessage(messageText) {
        if (!messageText.trim()) return;

        const selectedCode = getSelectedCodeItems();
        const selectedSummaries = getSelectedSummaryItems();
        const customSnippets = customContextSnippets;

        if (Object.keys(selectedCode).length === 0 && selectedSummaries.length === 0 && customSnippets.length === 0) {
            const errId = createMessage('assistant', `**Error:** Please select files, code snippets, or summaries before asking a question.`);
            renderMessage(errId);
            return;
        }

        const userMsgId = createMessage('user', messageText);
        renderMessage(userMsgId);
        ui.messageInput.value = '';
        ui.chatWindow.scrollTop = ui.chatWindow.scrollHeight;

        const thinkingWrapper = document.createElement('div');
        thinkingWrapper.className = 'flex mb-4 animate-fadeInUp justify-start';
        thinkingWrapper.innerHTML = `<div class="p-4 rounded-lg max-w-4xl chat-bubble-ai"><div class="thinking-indicator flex items-center space-x-2"><div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-green-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div><div class="w-2 h-2 bg-green-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div><span class="text-sm text-gray-400">Analyzing...</span></div></div>`;
        ui.chatWindow.appendChild(thinkingWrapper);
        ui.chatWindow.scrollTop = ui.chatWindow.scrollHeight;

        ui.sendBtn.disabled = true;
        ui.previewContextBtn.disabled = true;
        ui.messageInput.disabled = true;

        const historyForPrompt = [];
        for (const messageId of contextMessageIds) {
            const state = messageStore.get(messageId);
            if (state) historyForPrompt.push({ role: state.role, content: state.content });
        }

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: messageText,
                    selected_items: selectedCode,
                    selected_summaries: selectedSummaries,
                    custom_snippets: customSnippets,
                    history: historyForPrompt
                }),
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'The server returned an error.');
            const assistantMsgId = createMessage('assistant', result.answer);
            thinkingWrapper.remove();
            renderMessage(assistantMsgId);
        } catch (error) {
            const errorMsgId = createMessage('assistant', `<p class="text-red-400"><strong>Error:</strong> ${error.message}</p>`);
            thinkingWrapper.remove();
            renderMessage(errorMsgId);
        } finally {
            ui.sendBtn.disabled = false;
            ui.previewContextBtn.disabled = false;
            ui.messageInput.disabled = false;
            ui.chatWindow.scrollTop = ui.chatWindow.scrollHeight;
            updateChatUI();
        }
    }

    // --- Conversation Management ---
    function switchConversation(convoId) {
        activeConversationId = convoId;
        renderActiveConversation();
        ui.convoDropdownMenu.classList.add('hidden');
    }

    function renameConversation(convoId) {
        const convo = conversations[convoId];
        const newName = prompt(`Rename thread "${convo.name}":`, convo.name);
        if (newName && newName.trim()) {
            convo.name = newName.trim();
            updateConversationDropdown();
        }
    }

    function deleteConversation(convoId) {
        if (Object.keys(conversations).length <= 1) {
            alert("You cannot delete the last conversation thread.");
            return;
        }
        if (confirm(`Are you sure you want to delete "${conversations[convoId].name}"? This cannot be undone.`)) {
            const wasActive = activeConversationId === convoId;
            delete conversations[convoId];

            if (wasActive) {
                activeConversationId = conversations['main_thread'] ? 'main_thread' : Object.keys(conversations)[0];
                renderActiveConversation();
            } else {
                updateConversationDropdown();
            }
        }
    }

    function handleBranch(sourceMessageId) {
        const sourceConvo = conversations[activeConversationId];
        const branchIndex = sourceConvo.messages.indexOf(sourceMessageId);
        if (branchIndex === -1) return;

        const newName = prompt('Enter a name for the new branch:', `Branch of "${sourceConvo.name}"`);
        if (!newName || !newName.trim()) return;

        const newHistory = sourceConvo.messages.slice(0, branchIndex + 1);
        const newId = `thread-${Date.now()}`;
        initNewConversation(newId, newName.trim(), newHistory);
        switchConversation(newId);
    }

    function updateConversationDropdown() {
        ui.convoDropdownMenu.innerHTML = '';
        if (!activeConversationId) return;

        ui.activeConvoName.textContent = conversations[activeConversationId].name;

        for (const id in conversations) {
            const convo = conversations[id];
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-2 hover:bg-gray-700 text-sm';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'truncate pr-2 cursor-pointer flex-grow';
            nameSpan.textContent = convo.name;
            nameSpan.onclick = () => switchConversation(id);

            const controls = document.createElement('div');
            controls.className = 'flex items-center space-x-3 flex-shrink-0';

            if (id === activeConversationId) {
                controls.innerHTML = '<i class="fa-solid fa-check-circle text-green-500" title="Active Thread"></i>';
            }
            controls.innerHTML += `<button type="button" class="rename-btn text-gray-400 hover:text-white" data-convo-id="${id}" title="Rename"><i class="fa-solid fa-pencil"></i></button>`;
            controls.innerHTML += `<button type="button" class="delete-btn text-gray-400 hover:text-red-500" data-convo-id="${id}" title="Delete Thread"><i class="fa-solid fa-trash-can"></i></button>`;

            item.append(nameSpan, controls);
            ui.convoDropdownMenu.appendChild(item);
        }
    }

    // --- Modal Logic ---
    function populateChatContextModal() {
        ui.modalChatHistory.innerHTML = '';
        for (const messageId of conversations[activeConversationId].messages) {
            const state = messageStore.get(messageId);
            const entry = document.createElement('div');
            entry.className = `flex items-start p-3 rounded-lg ${state.role === 'user' ? 'bg-green-900/40' : 'bg-gray-800/60'}`;
            entry.innerHTML = `
                <input type="checkbox" id="modal-cb-${messageId}" data-message-id="${messageId}" ${contextMessageIds.has(messageId) ? 'checked' : ''} class="mt-1 h-4 w-4 rounded text-green-500 bg-gray-700 border-gray-600 focus:ring-green-600">
                <label for="modal-cb-${messageId}" class="ml-3 flex-1 cursor-pointer">
                    <div class="text-sm font-bold ${state.role === 'user' ? 'text-green-400' : 'text-blue-400'}">${state.role === 'user' ? 'You' : 'Assistant'}</div>
                    <div class="text-sm mt-1 text-gray-300">${state.content.substring(0, 300)}${state.content.length > 300 ? '...' : ''}</div>
                </label>
            `;
            ui.modalChatHistory.appendChild(entry);
        }
    }
    
    // A utility function to correctly escape backticks for safe insertion into template literals.
    function escapeForTemplate(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/`/g, '\\`');
    }

    async function populatePreviewContextModal() {
        ui.previewCodeContext.textContent = "Fetching context...";
        ui.previewHistoryContext.textContent = "";

        let codeContextParts = [];
        let historyContext = "";

        // Summaries
        const selectedSummaries = getSelectedSummaryItems();
        if (selectedSummaries.length > 0) {
            codeContextParts.push("## CONTEXT FROM AI-GENERATED SUMMARIES");
            selectedSummaries.forEach(s => {
                const itemDesc = s.name ? `item \`${s.name}\` in file \`${s.path}\`` : `file \`${s.path}\``;
                const escapedContent = escapeForTemplate(s.content);
                codeContextParts.push(`- **Summary for ${itemDesc}:** ${escapedContent}`);
            });
        }

        // Custom Snippets
        if (customContextSnippets.length > 0) {
            customContextSnippets.forEach(s => {
                const escapedContent = escapeForTemplate(s.content);
                codeContextParts.push(`--- SNIPPET FROM: ${s.source} ---\n\n${escapedContent}`);
            });
        }

        // Code selections (files and snippets)
        const selectedCode = getSelectedCodeItems();
        const snippetPromises = [];

        for (const path in selectedCode) {
            if (selectedCode[path].includes('__all__')) {
                const content = scannedFilesData[path]?.content || "Error: Content not found.";
                const escapedContent = escapeForTemplate(content);
                codeContextParts.push(`--- FILE: ${path} ---\n\n${escapedContent}`);
            } else {
                selectedCode[path].forEach(name => {
                    const promise = fetch('/extract_snippet', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ path, name })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.content) {
                            const escapedContent = escapeForTemplate(data.content);
                            return `--- SNIPPET FROM: ${path} (item: ${name}) ---\n\n${escapedContent}`;
                        }
                        return `--- SNIPPET FROM: ${path} (item: ${name}) ---\n\nError: Could not extract snippet.`;
                    });
                    snippetPromises.push(promise);
                });
            }
        }

        const resolvedSnippets = await Promise.all(snippetPromises);
        codeContextParts.push(...resolvedSnippets);

        // History
        for (const messageId of contextMessageIds) {
            const message = messageStore.get(messageId);
            if (message) {
                const escapedContent = escapeForTemplate(message.content);
                historyContext += `[${message.role.toUpperCase()}]\n${escapedContent}\n\n-----------------\n\n`;
            }
        }
        
        let finalCodeContext = "No code or summaries selected.";
        if (codeContextParts.length > 0) {
            finalCodeContext = "## CODEBASE CONTEXT\n\n" + codeContextParts.join('\n\n');
        }

        ui.previewCodeContext.textContent = finalCodeContext;
        ui.previewHistoryContext.textContent = historyContext.trim() || "No history items selected.";
    }

    // --- Search & Context Conflict ---
    async function handleSearch() {
        const query = ui.searchInput.value.trim();
        updateClearSearchBtnVisibility(); // NEW
        if (!query) return;

        ui.searchBtn.disabled = true;
        ui.searchSpinner.classList.remove('hidden');
        ui.searchBtnText.classList.add('hidden');
        ui.searchResultsContainer.innerHTML = `<div class="text-gray-400">Searching...</div>`;
        ui.searchPaginationContainer.innerHTML = '';

        try {
            const response = await fetch('/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query, sessionId: currentSessionId })
            });
            const results = await response.json();
            if (!response.ok) throw new Error(results.error || 'Search failed');

            fullSearchResults = results;
            searchResultsCurrentPage = 1;
            displaySearchResultsPage();

        } catch (error) {
            ui.searchResultsContainer.innerHTML = `<div class="text-red-400">Error: ${error.message}</div>`;
        } finally {
            ui.searchBtn.disabled = false;
            ui.searchSpinner.classList.add('hidden');
            ui.searchBtnText.classList.remove('hidden');
        }
    }

    function displaySearchResultsPage() {
        searchResultsStore = {};
        ui.searchResultsContainer.innerHTML = '';
        ui.searchPaginationContainer.innerHTML = '';
        updateClearSearchBtnVisibility(); // NEW

        if (fullSearchResults.length === 0) {
            ui.searchResultsContainer.innerHTML = `<div class="text-gray-400 italic">No results found.</div>`;
            return;
        }

        const totalPages = Math.ceil(fullSearchResults.length / RESULTS_PER_PAGE);
        const start = (searchResultsCurrentPage - 1) * RESULTS_PER_PAGE;
        const end = start + RESULTS_PER_PAGE;
        const pageResults = fullSearchResults.slice(start, end);

        ui.searchResultsContainer.innerHTML = pageResults.map((res, index) => {
            const resultId = `res-${start + index}`;
            searchResultsStore[resultId] = res;

            const itemName = res.item_name === '__file__' ? '<i>(File)</i>' : res.item_name;
            const score = (res.scoreDetails?.value || 0).toFixed(4);
            const descriptionHTML = res.summary ? `<p class="text-xs text-gray-400 mt-1 italic">"${res.summary}"</p>` : `<p class="text-xs text-gray-400 mt-1 italic">"${res.description}"</p>`;

            return `
                <div class="mongodb-dark-bg p-3 my-2 rounded-md border mongodb-border">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                           <div class="font-semibold text-green-400 truncate">${res.file_path}</div>
                           <div class="text-xs text-gray-300 ml-2">&hookrightarrow; ${itemName}</div>
                           ${descriptionHTML}
                        </div>
                        <div class="flex flex-col items-end ml-2">
                             <span class="text-xs font-mono text-gray-500 mb-2">${score}</span>
                             <button class="review-context-btn text-xs mongodb-green-bg mongodb-green-bg-hover px-2 py-1 rounded"
                                     data-result-id="${resultId}">
                                 <i class="fa-solid fa-pen-to-square mr-1"></i> Review & Add
                             </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        if (totalPages > 1) {
            const prevDisabled = searchResultsCurrentPage === 1 ? 'disabled' : '';
            const nextDisabled = searchResultsCurrentPage === totalPages ? 'disabled' : '';
            ui.searchPaginationContainer.innerHTML = `
                <button id="search-prev-btn" class="px-2 py-1 rounded mongodb-dark-bg border mongodb-border hover:bg-gray-700 disabled:opacity-50" ${prevDisabled}>&laquo; Prev</button>
                <span class="font-mono">${searchResultsCurrentPage} / ${totalPages}</span>
                <button id="search-next-btn" class="px-2 py-1 rounded mongodb-dark-bg border mongodb-border hover:bg-gray-700 disabled:opacity-50" ${nextDisabled}>Next &raquo;</button>
            `;
        }
    }
    
    // NEW: Function to clear search state and UI
    function clearSearch() {
        ui.searchInput.value = '';
        ui.searchResultsContainer.innerHTML = '';
        ui.searchPaginationContainer.innerHTML = '';
        fullSearchResults = [];
        searchResultsCurrentPage = 1;
        searchResultsStore = {};
        updateClearSearchBtnVisibility();
    }

    // NEW: Function to manage visibility of the clear button
    function updateClearSearchBtnVisibility() {
        const hasText = ui.searchInput.value.trim().length > 0;
        const hasResults = fullSearchResults.length > 0;
        ui.clearSearchBtn.classList.toggle('hidden', !hasText && !hasResults);
    }

    function updateFileTreeInteractivity() {
        const snippetPaths = new Set(customContextSnippets.map(s => s.path));

        ui.fileTree.querySelectorAll('details').forEach(detail => {
            const path = detail.dataset.path;
            const fileCheckbox = detail.querySelector('input[data-type="file-code"]');
            const lockIndicator = detail.querySelector('.lock-indicator');

            if (snippetPaths.has(path)) {
                fileCheckbox.disabled = true;
                fileCheckbox.checked = false;
                fileCheckbox.indeterminate = false;
                detail.querySelectorAll('input[data-type="item-code"]').forEach(cb => cb.checked = false);
                lockIndicator.classList.remove('hidden');
                lockIndicator.title = 'Remove custom snippets from this file to enable whole-file selection.';
            } else {
                fileCheckbox.disabled = false;
                lockIndicator.classList.add('hidden');
                lockIndicator.title = '';
            }
        });
    }

    // --- Indexing Status Polling & UX ---
    function enterIndexingState() {
        ui.indexingProgressSection.classList.remove('hidden');
        ui.indexingProgressSection.style.opacity = '1';
        ui.indexingProgressSection.classList.add('flex');
        ui.indexingProgressSection.classList.add('animate-fadeInUp');


        ui.searchInput.disabled = true;
        ui.searchBtn.disabled = true;
        ui.searchInput.placeholder = "Indexing in progress...";

        document.querySelectorAll('.snippet-summarize-btn').forEach(btn => btn.disabled = true);
        ui.messageInput.disabled = true;
        ui.sendBtn.disabled = true;
        ui.previewContextBtn.disabled = true;
        ui.messageInput.placeholder = "Please wait for indexing to complete...";

        let tipIndex = 0;
        ui.indexingProTip.textContent = PRO_TIPS[tipIndex];
        if (proTipInterval) clearInterval(proTipInterval);
        proTipInterval = setInterval(() => {
            tipIndex = (tipIndex + 1) % PRO_TIPS.length;
            ui.indexingProTip.classList.add('transition-opacity', 'opacity-0');
            setTimeout(() => {
                ui.indexingProTip.textContent = PRO_TIPS[tipIndex];
                ui.indexingProTip.classList.remove('opacity-0');
            }, 300);
        }, 4000);
    }

    function exitIndexingState() {
        ui.indexingProgressSection.style.opacity = '0';
        if (proTipInterval) clearInterval(proTipInterval);
        setTimeout(() => {
            ui.indexingProgressSection.classList.add('hidden');
            ui.indexingProgressSection.classList.remove('flex');
        }, 300); // match transition duration

        ui.searchInput.disabled = false;
        ui.searchBtn.disabled = false;
        ui.searchInput.placeholder = "Search indexed code...";
        ui.searchInput.classList.add('glow-on-ready');
        setTimeout(() => ui.searchInput.classList.remove('glow-on-ready'), 3000);


        document.querySelectorAll('.snippet-summarize-btn').forEach(btn => btn.disabled = false);
        updateChatUI(); // Re-evaluates chat input state
    }


    function startIndexingStatusPoller() {
        if (indexingStatusInterval) clearInterval(indexingStatusInterval);
        enterIndexingState();
        indexingStatusInterval = setInterval(fetchIndexingStatus, 2000);
        fetchIndexingStatus();
    }

    async function fetchIndexingStatus() {
        try {
            const response = await fetch('/status');
            const data = await response.json();
            if (!data) return;

            if (data.running) {
                const percentage = data.total > 0 ? (data.progress / data.total) * 100 : 0;
                ui.indexingProgressText.textContent = `Processing Snippets: ${data.progress} / ${data.total}`;
                ui.indexingProgressBar.style.width = `${percentage}%`;

                if (percentage < 33) {
                     ui.indexingStageText.textContent = "Phase 1/3: Generating summaries...";
                } else if (percentage < 66) {
                     ui.indexingStageText.textContent = "Phase 2/3: Creating embeddings...";
                } else {
                     ui.indexingStageText.textContent = "Phase 3/3: Writing to search index...";
                }

            } else {
                ui.indexingProgressBar.style.width = `100%`;
                clearInterval(indexingStatusInterval);
                indexingStatusInterval = null;

                if(data.total > 0 && data.progress >= data.total){
                  ui.indexingStageText.textContent = "All Systems Go!";
                  ui.indexingProgressText.textContent = "Indexing Complete!";
                  createMessage('assistant', `✅ Background indexing of ${data.total} snippets is complete. Search is now fully available.`);
                  renderActiveConversation();
                } else if (data.total === 0) {
                   ui.indexingStageText.textContent = "Scan Complete";
                   ui.indexingProgressText.textContent = "No snippets found to index.";
                }

                setTimeout(exitIndexingState, 1500);
            }
        } catch (error) {
            console.error("Error fetching indexing status:", error);
            ui.indexingProgressText.textContent = "Error fetching status.";
            clearInterval(indexingStatusInterval);
            indexingStatusInterval = null;
            setTimeout(exitIndexingState, 1000);
        }
    }

    // --- Event Listeners ---
    ui.newScanBtn.addEventListener('click', resetForNewScan);
    ui.chatForm.addEventListener('submit', (e) => { e.preventDefault(); handleSendMessage(ui.messageInput.value); });

    ui.presetButtons.addEventListener('click', (e) => {
        const btn = e.target.closest('.preset-btn');
        if (btn) handleSendMessage(btn.dataset.question);
    });

    ui.pathInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') ui.scanBtn.click(); });

    ui.searchBtn.addEventListener('click', handleSearch);
    ui.searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearch(); });
    ui.searchInput.addEventListener('input', updateClearSearchBtnVisibility); // NEW
    ui.clearSearchBtn.addEventListener('click', clearSearch); // NEW

    ui.searchPaginationContainer.addEventListener('click', e => {
        if (e.target.id === 'search-prev-btn') {
            searchResultsCurrentPage--;
            displaySearchResultsPage();
        } else if (e.target.id === 'search-next-btn') {
            searchResultsCurrentPage++;
            displaySearchResultsPage();
        }
    });

    ui.searchResultsContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('.review-context-btn');
        if (!btn) return;
    
        const resultId = btn.dataset.resultId;
        const resultData = searchResultsStore[resultId];
        if (!resultData) return;

        const fileDetailsElement = document.querySelector(`details[data-path="${resultData.file_path}"]`);
        const isFileLocked = fileDetailsElement.querySelector('input[data-type="file-code"]')?.disabled;

        // Show the warning only if the file isn't already locked by another snippet.
        if (!isFileLocked) {
            ui.reviewModalWarning.classList.remove('hidden');
        } else {
            ui.reviewModalWarning.classList.add('hidden');
        }

        const isFileSelected = fileDetailsElement.querySelector('input[data-type="file-code"]')?.checked;
    
        ui.reviewModalTitle.textContent = `Snippet from: ${resultData.file_path}`;
        ui.reviewModalCode.value = resultData.code;
        ui.addReviewedSnippetBtn.textContent = 'Add Snippet to Context';
        ui.addReviewedSnippetBtn.dataset.mode = 'add';
        ui.addReviewedSnippetBtn.dataset.source = `${resultData.file_path} (${resultData.item_name})`;
        ui.addReviewedSnippetBtn.dataset.path = resultData.file_path;
    
        if(isFileSelected) {
            ui.addReviewedSnippetBtn.disabled = true;
            ui.addReviewedSnippetBtn.title = 'This entire file is already selected for context. Unselect it to add a specific snippet.';
        } else {
            ui.addReviewedSnippetBtn.disabled = false;
            ui.addReviewedSnippetBtn.title = '';
        }
    
        ui.reviewContextModal.classList.remove('hidden');
    });

    ui.closeReviewModalBtn.addEventListener('click', () => ui.reviewContextModal.classList.add('hidden'));
    ui.cancelReviewModalBtn.addEventListener('click', () => ui.reviewContextModal.classList.add('hidden'));

    ui.addReviewedSnippetBtn.addEventListener('click', () => {
        const mode = ui.addReviewedSnippetBtn.dataset.mode;
        const content = ui.reviewModalCode.value;
        const btn = ui.addReviewedSnippetBtn;
        const originalButtonText = btn.innerHTML;
        
        if (mode === 'edit') {
            const snippetId = btn.dataset.editId;
            const snippet = customContextSnippets.find(s => s.id === snippetId);
            if (snippet) {
                snippet.content = content;
            }
            ui.reviewContextModal.classList.add('hidden');
            updateChatUI();
        } else { // mode === 'add'
            const newSnippetId = `custom-${Date.now()}`;
            const source = btn.dataset.source;
            const path = btn.dataset.path;
            
            customContextSnippets.push({
                id: newSnippetId,
                path: path,
                source: source,
                content: content
            });

            // --- NEW Intuitive Feedback UX ---
            btn.innerHTML = `<i class="fa-solid fa-check mr-2"></i>Added`;
            btn.disabled = true;

            setTimeout(() => {
                ui.reviewContextModal.classList.add('hidden');
                btn.innerHTML = originalButtonText; // Reset for next time
                btn.disabled = false;
                
                updateChatUI(); // This re-renders the list

                const newSnippetElement = document.querySelector(`[data-snippet-id="${newSnippetId}"]`);
                if (newSnippetElement) {
                    newSnippetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    newSnippetElement.classList.add('flash-on-add');
                    setTimeout(() => {
                        newSnippetElement.classList.remove('flash-on-add');
                    }, 1500); // Must match animation duration
                }
            }, 750); // Short delay to show the "Added" state in the modal
        }
    });

    ui.customContextSection.addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.remove-custom-snippet-btn');
        const editBtn = e.target.closest('.edit-custom-snippet-btn');

        if (removeBtn) {
            const snippetId = removeBtn.dataset.id;
            customContextSnippets = customContextSnippets.filter(s => s.id !== snippetId);
            updateChatUI();
        } else if (editBtn) {
            const snippetId = editBtn.dataset.id;
            const snippet = customContextSnippets.find(s => s.id === snippetId);
            if (!snippet) return;

            ui.reviewModalTitle.textContent = `Edit Snippet: ${snippet.source}`;
            ui.reviewModalCode.value = snippet.content;
            ui.addReviewedSnippetBtn.textContent = 'Save Changes';
            ui.addReviewedSnippetBtn.dataset.mode = 'edit';
            ui.addReviewedSnippetBtn.dataset.editId = snippet.id;
            ui.addReviewedSnippetBtn.disabled = false;
            ui.addReviewedSnippetBtn.title = '';
            ui.reviewContextModal.classList.remove('hidden');
        }
    });

    ui.manageContextBtn.addEventListener('click', () => {
        populateChatContextModal();
        ui.chatContextModal.classList.remove('hidden');
    });

    ui.closeChatContextModalBtn.addEventListener('click', () => {
        const newSelection = new Set();
        ui.modalChatHistory.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
            newSelection.add(cb.dataset.messageId);
        });
        contextMessageIds = newSelection;
        updateChatContextMeter();
        ui.chatContextModal.classList.add('hidden');
    });

    ui.modalSelectAll.addEventListener('click', () => ui.modalChatHistory.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true));
    ui.modalDeselectAll.addEventListener('click', () => ui.modalChatHistory.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false));

    ui.convoDropdownBtn.addEventListener('click', () => ui.convoDropdownMenu.classList.toggle('hidden'));

    ui.convoDropdownMenu.addEventListener('click', (e) => {
        const renameBtn = e.target.closest('.rename-btn');
        const deleteBtn = e.target.closest('.delete-btn');
        if (renameBtn) { e.stopPropagation(); renameConversation(renameBtn.dataset.convoId); }
        if (deleteBtn) { e.stopPropagation(); deleteConversation(deleteBtn.dataset.convoId); }
    });

    ui.chatWindow.addEventListener('click', (e) => {
        const branchBtn = e.target.closest('.branch-btn');
        if (branchBtn) handleBranch(branchBtn.dataset.messageId);

        const fileLink = e.target.closest('.recommended-file-link');
        if (fileLink) {
            const path = fileLink.dataset.path;
            const detailsElement = document.querySelector(`details[data-path="${path}"]`);
            if (detailsElement) {
                detailsElement.open = true;
                detailsElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });

    ui.fileTree.addEventListener('click', (e) => {
        const summaryBtn = e.target.closest('.summarize-btn');
        if (summaryBtn) {
            e.preventDefault();
            e.stopPropagation();
            handleFetchSummary(summaryBtn.dataset.path, summaryBtn.dataset.name);
        }
    });

    ui.fileTree.addEventListener('change', (e) => {
        const checkbox = e.target;
        if (checkbox.type !== 'checkbox') return;

        const detail = checkbox.closest('details');

        if (checkbox.dataset.type === 'file-code') {
            detail.querySelectorAll('input[data-type="item-code"]').forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }
        else if (checkbox.dataset.type === 'item-code') {
            const fileCheckbox = detail.querySelector('input[data-type="file-code"]');
            const allItems = detail.querySelectorAll('input[data-type="item-code"]');
            const checkedItems = detail.querySelectorAll('input[data-type="item-code"]:checked');
            if (checkedItems.length === 0) {
                fileCheckbox.checked = false;
                fileCheckbox.indeterminate = false;
            } else if (allItems.length === checkedItems.length) {
                fileCheckbox.checked = true;
                fileCheckbox.indeterminate = false;
            } else {
                fileCheckbox.checked = false;
                fileCheckbox.indeterminate = true;
            }
        }

        updateChatUI();
    });

    ui.previewContextBtn.addEventListener('click', () => {
        populatePreviewContextModal();
        ui.previewContextModal.classList.remove('hidden');
    });
    ui.closePreviewContextModalBtn.addEventListener('click', () => ui.previewContextModal.classList.add('hidden'));

    // --- Initial Setup ---
    resetForNewScan();
});
</script>
</body>
</html>